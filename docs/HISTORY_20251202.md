# 프로젝트 변경 이력 (History)

이 문서는 프로젝트의 주요 변경 사항을 기능별로 기록합니다.

## 2025-12-02

### 1. 사용자 관리 (User Management)
- **ID/이름 분리**: 기존 `username` 필드를 사용자 ID로, `name` 필드를 실명으로 명확히 분리하여 UI에 반영.
- **회원가입 정책 변경**: 
  - 공개 회원가입 기능 제거 (로그인 페이지에서 링크 삭제).
  - 관리자(ADMIN)에 의한 사용자 등록/수정/삭제(탈퇴) 기능 구현.
- **내 정보 수정**: 로그인한 사용자가 자신의 이름과 이메일을 수정할 수 있는 프로필 페이지(`/profile`) 추가.
- **Mock 데이터 영속성**: `localStorage`를 활용하여 브라우저 새로고침 후에도 사용자 데이터(추가/수정/삭제)가 유지되도록 개선.

### 2. SR 관리 (SR Management)
- **SR ID 포맷 변경**: 
  - 기존 DB Sequence ID 대신 비즈니스 로직이 적용된 ID 체계 도입.
  - 포맷: `SR-YYMM-XXXX` (예: `SR-2412-0001`).
  - 월별 순차 번호 부여 로직 구현 (Backend & Frontend Mock).
- **목록 UI 개선**:
  - DB ID 대신 순차적인 번호(No.) 표시 (전체 데이터 기준 역순).
  - 데이터가 없을 경우에도 테이블 헤더를 유지하고, "데이터가 없습니다" 메시지를 중앙 정렬하여 표시.
- **데이터 초기화**: 로컬 스토리지의 모든 데이터를 초기화할 수 있는 버튼 추가 (테스트 편의성 증대).

### 3. UI/UX 개선
- **로그인 화면**: 화면 정중앙 배치 (`position: fixed` 활용)로 레이아웃 안정화.
- **목록 공통 스타일**: SR 목록, 사용자 목록, 현황조사 목록의 "데이터 없음" 표시 스타일 통일.
- **헤더**: 사용자 이름 클릭 시 프로필 페이지로 이동하도록 링크 추가.

### 4. OPEN API 현황조사
- **기능 추가**: OPEN API 전환 지원을 위한 현황조사 등록 및 조회 기능 구현.
- **SR 연동**: SR 등록 시 현황조사 데이터를 연동할 수 있는 구조 마련.
- **행정기관 데이터 연동**: 
  - 행정표준코드 기반의 기관 검색 기능 구현.
  - 백엔드 DB(`organizations` 테이블)에 초기 데이터 적재 및 조회 API 구현.
  - 운영 환경에서도 DB 데이터를 활용하도록 프론트엔드 서비스 로직 개선.
- **기능 개선**:
  - 상세 조회 화면을 수정 화면으로 통합 (등록/수정 폼 재사용).
  - 파일 첨부(Drag & Drop) 및 다운로드 기능 추가.
  - 운영인력보유 항목 세분화 (자체운영, 전문인력 상주/비상주, 기타).
  - 유지보수 비고 항목을 '유지보수 담당자 정보'로 변경 및 입력 가이드 추가.

### 5. SR 이력 관리 (SR History Management)
- **이력 자동 기록**: SR 정보 수정 시 주요 변경사항(상태, 우선순위, 담당자 등)이 자동으로 기록되도록 구현 (Auditing).
- **댓글 기능**: SR 처리 과정에서 의견을 남길 수 있는 댓글(Comment) 기능 추가.
- **타임라인 UI**: 
  - SR 상세 화면 우측에 변경 이력과 댓글을 최신순 타임라인으로 시각화.
  - **상세 비교(Diff View)**: 요청사항이나 처리내용 등 긴 텍스트 변경 시, 변경 전/후 내용을 아코디언 형태로 비교하여 보여주는 기능 구현.
  - 변경 내용이 없는 경우(초기 입력 등)에도 유연하게 처리되도록 개선.
- **백엔드 구조 확장**: 
  - `SrHistory` 엔티티에 `previousValue`, `newValue` 컬럼 추가하여 상세 변경 내역 저장.
  - 관련 API(`GET /api/sr/{id}/histories`, `POST /api/sr/{id}/histories`) 응답 구조 개선.

### 6. UI/UX 및 데이터 포맷팅 고도화 (추가)
- **모달 UX 개선**: 
  - `ESC` 키를 눌러 모달을 닫을 수 있는 기능 추가.
  - 모달 외부(Overlay) 클릭 시 의도치 않게 닫히는 현상 방지.
- **데이터 표시 개선**: 
  - SR 목록 및 상세 화면에서 사용자 ID 대신 **실명(Name)**이 표시되도록 변경.
  - 검색 버튼 텍스트 줄바꿈 방지 (`white-space: nowrap`).
- **전화번호 포맷팅**: 
  - 연락처 입력 및 조회 시 `010-****-1234` 형식으로 자동 마스킹/포맷팅 처리 적용.
  - 적용 범위: SR 등록/수정 폼, SR 상세 정보, OPEN API 현황조사 정보 카드, OPEN API 현황조사 등록 폼.
- **이력 추적 강화**: 
  - 요청자 정보(이름, 연락처) 변경 시에도 이력이 남도록 백엔드/프론트엔드 로직 추가.
  - 변경 이력 목록에서 긴 텍스트(요청내용 등)는 아코디언 형태로, 짧은 정보(연락처 등)는 한 줄로 표시되도록 UI 개선.
- **용어 변경**: SR 상세 화면의 '생성일' 라벨을 **'등록일(접수일)'**로 변경하여 의미 명확화.

### 7. 시스템 설정 및 트러블슈팅 (System Configuration & Troubleshooting)
- **CUBRID 데이터베이스 연동 이슈 해결**:
  - **문제**: Spring Boot 3.x (Hibernate 6.x) 환경에서 CUBRID 연결 시 `ClassNotFoundException: org.hibernate.dialect.CUBRIDDialect` 및 스키마 조회 오류(`Unknown class "information_schema.sequences"`) 발생.
  - **원인**: Hibernate 6.x 버전과 CUBRID JDBC 드라이버 간의 Dialect 호환성 문제 (기본 Dialect 부재 및 메타데이터 조회 쿼리 불일치).
  - **해결**: `MySQLDialect`를 상속받은 커스텀 `CubridDialect` (`com.srmanagement.config.CubridDialect`) 구현 및 `application.yml` 설정 적용.
- **ID 생성 전략 변경 (IDENTITY -> SEQUENCE)**:
  - **문제**: 로그인/회원가입 시 `NullPointerException` 발생 (CUBRID JDBC 드라이버의 `getGeneratedKeys` 미지원/버그).
  - **해결**: JPA ID 생성 전략을 `IDENTITY`에서 `SEQUENCE`(`SERIAL`)로 변경하고, `CubridDialect`에 `SequenceSupport` 구현 추가. `schema.sql`을 통해 수동으로 테이블 및 시퀀스 생성.
- **UUID 타입 변환 오류 해결**:
  - **문제**: 재로그인 시 `RefreshToken` 조회 중 `Type conversion error` 발생 (DB의 `VARCHAR`와 Java의 `UUID` 간 매핑 실패).
  - **해결**: `RefreshToken` 엔티티의 ID 필드에 `@JdbcTypeCode(SqlTypes.VARCHAR)` 어노테이션 추가.
- **Refresh Token 중복 및 동시성 이슈 해결**:
  - **문제**: 스크립트 테스트 등 빠른 연속 요청 시 `500 Internal Server Error` 발생 (`Unique constraint violation: u_refresh_tokens_token`).
  - **원인**: 토큰 생성 로직이 시간(초)에만 의존하여 동일한 토큰이 생성됨. 또한, `delete` 후 `insert` 시점의 플러시 지연으로 인한 경합 발생.
  - **해결**: 
    1. `JwtTokenProvider`에서 토큰 생성 시 랜덤 UUID(`jti`)를 포함하여 유일성 보장.
    2. `AuthService`에서 기존 토큰 삭제 후 즉시 `flush()` 호출하여 DB 반영 보장.
    3. H2 DB 시작 시 CUBRID 전용 SQL 실행 방지를 위해 `schema.sql`을 `schema-cubrid.sql`로 변경.
- **Refresh Token 중복 및 동시성 이슈 해결**:
  - **문제**: 스크립트 테스트 등 빠른 연속 요청 시 `500 Internal Server Error` 발생 (`Unique constraint violation: u_refresh_tokens_token`).
  - **원인**: 토큰 생성 로직이 시간(초)에만 의존하여 동일한 토큰이 생성됨. 또한, `delete` 후 `insert` 시점의 플러시 지연으로 인한 경합 발생.
  - **해결**: 
    1. `JwtTokenProvider`에서 토큰 생성 시 랜덤 UUID(`jti`)를 포함하여 유일성 보장.
    2. `AuthService`에서 기존 토큰 삭제 후 즉시 `flush()` 호출하여 DB 반영 보장.
    3. H2 DB 시작 시 CUBRID 전용 SQL 실행 방지를 위해 `schema.sql`을 `schema-cubrid.sql`로 변경.

---

## 이전 변경 사항 (요약)

### 초기 구축
- **Backend**: Spring Boot 3.x, JPA, JWT 인증, Security 설정.
- **Frontend**: React 18, TypeScript, Vite, Redux Toolkit.
- **기본 기능**: 로그인, 회원가입, SR CRUD, 댓글(처리내용) 기능.
