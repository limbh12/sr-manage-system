# 변경 이력 - 2025-12-11

## SR 소프트 삭제 및 복구 기능 구현

### 개요
SR 관리 시스템에 소프트 삭제(Soft Delete) 및 복구(Restore) 기능을 구현했습니다. 물리적 삭제 대신 삭제 플래그를 설정하여 데이터를 보존하고, 관리자가 삭제된 항목을 복구할 수 있도록 했습니다.

---

## 주요 변경 사항

### 1. 소프트 삭제 기능

#### Backend 구현

**Sr 엔티티 (`Sr.java`)**
- `deleted` 필드 추가: 삭제 여부를 나타내는 Boolean 플래그 (기본값: false)
- `deletedAt` 필드 추가: 삭제 일시를 기록하는 LocalDateTime
- `restore()` 메서드 추가: 삭제를 취소하는 복구 메서드

```java
/** 삭제 여부 (소프트 삭제) */
@Column(nullable = false)
@Builder.Default
private Boolean deleted = false;

/** 삭제 일시 */
private LocalDateTime deletedAt;

/**
 * SR 복구 (소프트 삭제 취소)
 */
public void restore() {
    this.deleted = false;
    this.deletedAt = null;
}
```

**SrRepository (`SrRepository.java`)**
- 삭제 여부 기반 쿼리 메서드 추가:
  - `findByDeleted(Boolean deleted, Pageable pageable)`
  - `findByStatusAndDeleted(SrStatus status, Boolean deleted, Pageable pageable)`
  - `findByPriorityAndDeleted(Priority priority, Boolean deleted, Pageable pageable)`
  - `findByStatusAndPriorityAndDeleted(...)`
  - `searchByTitleOrDescriptionAndDeleted(...)`

**SrService (`SrService.java`)**
- `deleteSr()` 메서드를 소프트 삭제로 변경:
  - 물리적 삭제 대신 `deleted` 플래그를 true로 설정
  - `deletedAt`에 현재 시각 기록
  - 삭제 이력 자동 생성
- `getSrList()` 메서드에 `includeDeleted` 파라미터 추가:
  - 관리자가 삭제된 항목 포함 여부 선택 가능
  - 삭제 여부에 따라 적절한 Repository 메서드 호출

```java
// 소프트 삭제: deleted 플래그를 true로 설정
sr.setDeleted(true);
sr.setDeletedAt(LocalDateTime.now());
srRepository.save(sr);

// 삭제 이력 기록
createHistory(sr, "SR이 삭제되었습니다.", SrHistoryType.INFO_CHANGE, user);
```

**SrController (`SrController.java`)**
- `getSrList()` API에 `includeDeleted` 파라미터 추가:
  - 관리자 권한 체크 로직 구현
  - 관리자가 아닌 경우 삭제된 항목 조회 불가

```java
// 관리자가 아닌 경우 삭제된 항목 포함 불가
Boolean showDeleted = false;
if (includeDeleted != null && includeDeleted) {
    User user = userRepository.findByUsername(authentication.getName())
            .orElseThrow(() -> new CustomException("User not found", HttpStatus.NOT_FOUND));
    if (user.getRole() == Role.ADMIN) {
        showDeleted = true;
    }
}
```

**Database Schema (`schema-cubrid.sql`)**
- `sr` 테이블에 컬럼 추가:
  - `deleted BOOLEAN NOT NULL DEFAULT FALSE`
  - `deleted_at TIMESTAMP`

#### Frontend 구현

**Types (`types/index.ts`)**
- `Sr` 인터페이스에 필드 추가:
  - `deleted?: boolean`
  - `deletedAt?: string`

**SR Service (`srService.ts`)**
- `GetSrListParams` 인터페이스에 `includeDeleted` 추가
- API 호출 시 삭제된 항목 포함 여부 전달

**Redux Store (`srSlice.ts`)**
- `FetchSrListParams`에 `includeDeleted` 파라미터 추가
- 목록 조회 시 삭제된 항목 필터링 지원

**Custom Hook (`useSr.ts`)**
- `FetchSrListParams`에 `includeDeleted` 추가
- 컴포넌트에서 삭제된 항목 조회 제어 가능

**SR List Component (`SrList.tsx`)**
- 삭제된 항목 시각적 표시:
  - 행 투명도 60%로 설정 (`opacity: 0.6`)
  - 제목에 취소선 스타일 적용 (`text-decoration: line-through`)
  - "(삭제됨)" 라벨 표시
- 삭제 버튼은 삭제되지 않은 항목에만 표시

```typescript
<tr key={sr.id} style={{ opacity: sr.deleted ? 0.6 : 1 }}>
  <td>
    <a style={{
      color: '#1976d2',
      textDecoration: sr.deleted ? 'line-through' : 'none'
    }}>
      {sr.title}
    </a>
    {sr.deleted && <span style={{ marginLeft: '8px', color: '#999', fontSize: '12px' }}>(삭제됨)</span>}
  </td>
  ...
  <td>
    {!sr.deleted && (
      <button className="btn btn-danger" onClick={() => onDeleteSr(sr.id)}>
        삭제
      </button>
    )}
  </td>
</tr>
```

**SR Management Page (`SrManagementPage.tsx`)**
- "삭제된 항목 포함" 체크박스 추가:
  - 관리자에게만 표시 (`{isAdmin && (...)`)
  - 체크 시 삭제된 SR 목록 포함 조회
  - 체크박스 변경 시 즉시 목록 갱신

```typescript
{isAdmin && (
  <div className="form-group" style={{ marginBottom: 0 }}>
    <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
      <input
        type="checkbox"
        checked={includeDeleted}
        onChange={(e) => {
          const checked = e.target.checked;
          setIncludeDeleted(checked);
          fetchSrList({
            page: 0,
            status: statusFilter || undefined,
            priority: priorityFilter || undefined,
            search: searchQuery || undefined,
            includeDeleted: checked,
          });
        }}
        style={{ cursor: 'pointer' }}
      />
      <span>삭제된 항목 포함</span>
    </label>
  </div>
)}
```

---

### 2. SR 복구 기능 (관리자 전용)

#### Backend 구현

**SrService (`SrService.java`)**
- `restoreSr()` 메서드 추가:
  - 관리자 권한 체크 (관리자만 복구 가능)
  - 이미 복구된 SR인지 확인
  - `restore()` 메서드 호출하여 복구
  - 복구 이력 자동 생성

```java
/**
 * SR 복구 (소프트 삭제 취소) - 관리자 전용
 */
@Transactional
public SrResponse restoreSr(Long id, String username) {
    Sr sr = srRepository.findById(id)
            .orElseThrow(() -> new CustomException("SR not found with id: " + id, HttpStatus.NOT_FOUND));

    User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new CustomException("User not found", HttpStatus.NOT_FOUND));

    // 권한 체크: 관리자만 복구 가능
    if (user.getRole() != Role.ADMIN) {
        throw new CustomException("복구 권한이 없습니다. 관리자만 복구할 수 있습니다.", HttpStatus.FORBIDDEN);
    }

    // 이미 복구된 SR인지 확인
    if (!sr.getDeleted()) {
        throw new CustomException("이미 복구된 SR입니다.", HttpStatus.BAD_REQUEST);
    }

    // SR 복구
    sr.restore();
    Sr restoredSr = srRepository.save(sr);

    // 복구 이력 기록
    createHistory(sr, "SR이 복구되었습니다.", SrHistoryType.INFO_CHANGE, user);

    return SrResponse.from(restoredSr);
}
```

**SrController (`SrController.java`)**
- `POST /api/sr/{id}/restore` 엔드포인트 추가:
  - 관리자만 호출 가능
  - 복구된 SR 정보 반환

```java
/**
 * SR 복구 (소프트 삭제 취소) - 관리자 전용
 */
@PostMapping("/{id}/restore")
public ResponseEntity<SrResponse> restoreSr(@PathVariable Long id, Authentication authentication) {
    SrResponse response = srService.restoreSr(id, authentication.getName());
    return ResponseEntity.ok(response);
}
```

#### Frontend 구현

**SR Service (`srService.ts`)**
- `restoreSr()` 함수 추가:
  - POST `/sr/{id}/restore` API 호출
  - Mock 모드에서는 미지원 (에러 throw)

```typescript
/**
 * SR 복구 (관리자 전용)
 */
export const restoreSr = async (id: number): Promise<Sr> => {
  if (USE_MOCK) {
    throw new Error('Mock mode does not support restore functionality');
  }
  const response = await api.post<Sr>(`/sr/${id}/restore`);
  return response.data;
};
```

**Redux Store (`srSlice.ts`)**
- `restoreSrAsync` 비동기 액션 추가
- 복구 완료 시 목록 업데이트 리듀서 구현:
  - `srList`에서 해당 SR 업데이트
  - `currentSr`도 함께 업데이트

```typescript
/**
 * SR 복구 액션 (관리자 전용)
 */
export const restoreSrAsync = createAsyncThunk<Sr, number, { rejectValue: string }>(
  'sr/restore',
  async (id, { rejectWithValue }) => {
    try {
      return await srService.restoreSr(id);
    } catch (error) {
      if (error instanceof Error) {
        return rejectWithValue(error.message);
      }
      return rejectWithValue('Failed to restore SR');
    }
  }
);
```

**Custom Hook (`useSr.ts`)**
- `restoreSr()` 함수 추가 및 export
- Redux 액션 호출 후 성공 여부 반환

**SR List Component (`SrList.tsx`)**
- Props에 `onRestoreSr` 콜백과 `isAdmin` 플래그 추가
- 삭제된 항목에만 "복구" 버튼 표시 (관리자에게만):
  - 조건: `sr.deleted && isAdmin && onRestoreSr`
  - 버튼 클래스: `btn btn-primary`
  - 클릭 시 `onRestoreSr(sr.id)` 호출

```typescript
{sr.deleted && isAdmin && onRestoreSr ? (
  <button
    className="btn btn-primary"
    onClick={() => onRestoreSr(sr.id)}
    style={{ marginRight: '8px' }}
  >
    복구
  </button>
) : null}
```

**SR Management Page (`SrManagementPage.tsx`)**
- `handleRestore()` 핸들러 추가:
  - 확인 다이얼로그 표시
  - 복구 성공 시 목록 갱신
- `SrList`에 복구 관련 props 전달:
  - `onRestoreSr={handleRestore}`
  - `isAdmin={isAdmin}`

```typescript
const handleRestore = async (id: number) => {
  if (window.confirm('이 SR을 복구하시겠습니까?')) {
    const success = await restoreSr(id);
    if (success) {
      // 목록 갱신
      handleSearch();
    }
  }
};
```

---

### 3. 데이터베이스 스키마 업데이트

**DATABASE.md 문서 업데이트**
- SR 테이블 정의에 필드 추가:
  - `deleted`: 삭제 여부 (소프트 삭제)
  - `deleted_at`: 삭제 일시
  - `applicant_name`: 요청자 이름 (이전 누락분 추가)
  - `applicant_phone`: 요청자 연락처 (이전 누락분 추가)
- 모든 DB 방언(CUBRID, MySQL, PostgreSQL)에 스키마 반영
- 인덱스 추가: `INDEX idx_sr_deleted (deleted)`

---

## 적용 파일 목록

### Backend (6개 파일)
1. `backend/src/main/java/com/srmanagement/entity/Sr.java`
   - deleted, deletedAt 필드 추가
   - restore() 메서드 추가

2. `backend/src/main/java/com/srmanagement/repository/SrRepository.java`
   - 삭제 여부 기반 쿼리 메서드 추가

3. `backend/src/main/java/com/srmanagement/service/SrService.java`
   - 소프트 삭제 로직 구현
   - restoreSr() 메서드 추가
   - getSrList에 includeDeleted 지원

4. `backend/src/main/java/com/srmanagement/controller/SrController.java`
   - POST /api/sr/{id}/restore 엔드포인트 추가
   - GET /api/sr에 includeDeleted 파라미터 추가

5. `backend/src/main/java/com/srmanagement/dto/response/SrResponse.java`
   - deleted, deletedAt 필드 추가

6. `backend/src/main/resources/schema-cubrid.sql`
   - sr 테이블에 deleted, deleted_at 컬럼 추가

### Frontend (6개 파일)
1. `frontend/src/types/index.ts`
   - Sr 인터페이스에 deleted, deletedAt 추가

2. `frontend/src/services/srService.ts`
   - GetSrListParams에 includeDeleted 추가
   - restoreSr() 함수 추가

3. `frontend/src/store/srSlice.ts`
   - FetchSrListParams에 includeDeleted 추가
   - restoreSrAsync 액션 추가
   - 복구 리듀서 추가

4. `frontend/src/hooks/useSr.ts`
   - FetchSrListParams에 includeDeleted 추가
   - restoreSr 함수 추가

5. `frontend/src/components/sr/SrList.tsx`
   - 삭제된 항목 시각적 표시
   - 복구 버튼 추가

6. `frontend/src/pages/SrManagementPage.tsx`
   - "삭제된 항목 포함" 체크박스 추가
   - handleRestore 핸들러 추가

### 문서 (1개 파일)
1. `docs/DATABASE.md`
   - SR 테이블 스키마 업데이트

---

## 기능 요약

### ✅ 구현된 기능
1. **소프트 삭제**
   - 물리적 삭제 대신 deleted 플래그 설정
   - 삭제 일시 자동 기록
   - 삭제 이력 자동 생성

2. **삭제된 항목 조회** (관리자 전용)
   - "삭제된 항목 포함" 체크박스
   - 일반 사용자는 체크박스 미표시
   - 관리자만 삭제된 SR 조회 가능

3. **삭제된 항목 시각적 구분**
   - 행 투명도 60%
   - 제목 취소선 표시
   - "(삭제됨)" 라벨 표시

4. **SR 복구** (관리자 전용)
   - "복구" 버튼 (삭제된 항목에만 표시)
   - 관리자 권한 체크
   - 복구 이력 자동 생성
   - 확인 다이얼로그

5. **권한 기반 UI**
   - 관리자: 체크박스 표시, 복구 버튼 표시
   - 일반 사용자: 삭제된 항목 조회 불가

6. **이력 추적**
   - 삭제 시 이력 기록
   - 복구 시 이력 기록
   - SR 상세에서 전체 이력 확인 가능

---

## API 명세

### 1. SR 목록 조회
```
GET /api/sr?includeDeleted={boolean}
```
- **파라미터**: `includeDeleted` (선택, 관리자만 사용)
- **권한**: 인증 필요, 관리자만 삭제된 항목 조회 가능
- **응답**: Page<SrResponse>

### 2. SR 복구
```
POST /api/sr/{id}/restore
```
- **권한**: 관리자 전용
- **응답**: SrResponse (복구된 SR 정보)
- **오류**:
  - 403: 관리자가 아닌 경우
  - 400: 이미 복구된 SR인 경우
  - 404: SR을 찾을 수 없는 경우

---

## 데이터베이스 마이그레이션

### 기존 데이터베이스 업데이트 SQL

**CUBRID / MySQL / PostgreSQL 공통:**
```sql
-- sr 테이블에 컬럼 추가
ALTER TABLE sr ADD COLUMN deleted BOOLEAN NOT NULL DEFAULT FALSE;
ALTER TABLE sr ADD COLUMN deleted_at TIMESTAMP NULL;

-- 인덱스 추가 (선택사항, 성능 향상)
CREATE INDEX idx_sr_deleted ON sr(deleted);
```

---

## 테스트 시나리오

### 1. 소프트 삭제 테스트
1. 일반 사용자로 로그인
2. 자신이 생성한 SR 삭제
3. SR 목록에서 해당 항목이 사라짐 확인
4. 관리자로 로그인
5. "삭제된 항목 포함" 체크
6. 삭제된 SR이 취소선으로 표시됨 확인

### 2. 복구 기능 테스트
1. 관리자로 로그인
2. "삭제된 항목 포함" 체크
3. 삭제된 SR의 "복구" 버튼 클릭
4. 확인 다이얼로그에서 확인
5. SR이 복구되어 정상 표시됨 확인
6. SR 상세 → 이력에서 "SR이 복구되었습니다" 확인

### 3. 권한 테스트
1. 일반 사용자로 로그인
2. "삭제된 항목 포함" 체크박스가 보이지 않음 확인
3. API로 직접 복구 시도 시 403 오류 확인
4. 관리자로 로그인
5. 체크박스와 복구 버튼이 정상 표시됨 확인

---

## 주의사항

### 개발 환경
- 기존 H2 데이터베이스 사용 시 스키마가 자동으로 재생성됨 (`ddl-auto: create`)
- 데이터 보존이 필요한 경우 `ddl-auto: update` 사용 권장

### 운영 환경
- 운영 DB에 반드시 마이그레이션 SQL 실행 필요
- 기존 SR 데이터는 `deleted = false`로 자동 설정됨
- 백업 후 마이그레이션 수행 권장

### Mock 모드
- Mock 모드에서는 복구 기능 미지원
- `USE_MOCK = false`로 설정하여 실제 API 사용 권장

---

## 향후 개선 사항

1. **물리적 삭제 기능** (선택)
   - 삭제된 지 일정 기간(예: 30일) 경과한 SR 자동 삭제
   - 관리자 설정 화면에서 보관 기간 설정

2. **삭제 사유 기록**
   - 삭제 시 사유 입력 받기
   - 이력에 사유 포함

3. **대량 복구 기능**
   - 여러 SR을 한 번에 복구
   - 체크박스로 선택 후 일괄 복구

4. **삭제 통계**
   - 대시보드에 삭제된 SR 통계 표시
   - 복구율, 삭제 사유 분석

---

## 커밋 정보
- **커밋 해시**: `3884de8`
- **커밋 날짜**: 2025-12-11
- **변경 파일**: 13개
- **추가 라인**: 412줄
- **삭제 라인**: 67줄
