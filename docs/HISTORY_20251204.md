# 프로젝트 변경 이력 (History)

이 문서는 프로젝트의 주요 변경 사항을 기능별로 기록합니다.

## 2025-12-04

### 1. 데이터베이스 설정 (Database Configuration)
- **H2 Database 파일 모드 전환**:
  - 기존 In-Memory 모드에서 File 모드로 변경하여 서버 재시작 시에도 데이터가 유지되도록 개선.
  - 데이터 저장 경로: `backend/data/srdb` (절대 경로 사용).
  - `application.yml` 설정 변경: `jdbc:h2:file:...;AUTO_SERVER=TRUE`.
- **H2 Console 접근 허용**:
  - Spring Security 설정(`SecurityConfig.java`) 수정.
  - `/h2-console/**` 경로에 대한 접근 허용, CSRF 비활성화, X-Frame-Options(SAMEORIGIN) 허용.

### 2. 프론트엔드 (Frontend)
- **Mock 데이터 강화**:
  - `VITE_USE_MOCK=true`를 기본값으로 설정하여 개발 편의성 증대.
  - OPEN API 현황조사 초기 Mock 데이터(`INITIAL_SURVEY_LIST`) 추가 및 로컬 스토리지 연동 로직 개선.
- **버그 수정**:
  - `OrganizationSearchModal` 컴포넌트에서 조건부 Hook 호출 위반 문제 해결 (`useEffect` 위치 조정).

### 3. 백엔드 리팩토링 및 DB 초기화 설정 (Backend Refactoring & DB Reset)
- **DB 초기화 정책 변경**:
  - `application.yml`의 `spring.jpa.hibernate.ddl-auto` 옵션을 `create`로 변경.
  - 서버 시작 시마다 기존 테이블을 삭제하고 새로 생성하여 데이터 정합성 보장 (파일 모드 유지).
- **Entity 매핑 개선 (`OpenApiSurvey`)**:
  - `DuplicateMappingException` 해결: `organizationCode` 컬럼에 대해 읽기 전용(`insertable=false, updatable=false`) 설정.
  - `Organization` 엔티티와의 `@ManyToOne` 관계 매핑 추가.
- **서비스/리포지토리 리팩토링**:
  - `OpenApiSurveyRepository`: 삭제된 필드 대신 `Organization`을 조인(JOIN)하여 검색하도록 JPQL 수정.
  - `OpenApiSurveyService`: 단순 문자열 코드 대신 엔티티 객체 관계를 활용하도록 로직 전면 수정.

### 4. 기관 관리 구조 변경 (Organization Management Refactoring)
- **기관명(Name) → 기관코드(Code) 중심 설계 변경**:
  - 기존: 설문(`OpenApiSurvey`) 테이블에 기관명(`organizationName`)을 직접 저장.
  - 변경: 기관 표준 코드(`organizationCode`)를 저장하고, `Organization` 테이블과 관계(FK)를 맺어 관리.
  - 목적: 데이터 정합성 확보 및 기관명 변경 시 유연한 대응.
- **DTO 및 API 수정**:
  - `OpenApiSurveyCreateRequest`: `organizationName` 필드 삭제, `organizationCode` 필드 필수화.
  - `OpenApiSurveyResponse`: `organization` 객체를 포함하여 코드와 이름을 함께 반환하도록 구조 변경.
- **프론트엔드 연동 수정**:
  - `SurveyForm`: 기관 검색 모달을 통해 선택된 기관의 '코드'를 전송하도록 수정.
  - `SurveyList`: 응답받은 `organization` 객체에서 이름을 추출하여 표시하도록 수정.
  - `types/index.ts`: `OpenApiSurvey` 인터페이스 타입 정의 업데이트.

### 5. CSV 일괄 등록 기능 구현 (CSV Bulk Upload)
- **백엔드**:
  - `opencsv` 라이브러리 추가 (`pom.xml`).
  - `OpenApiSurveyController`: `/api/surveys/upload` 엔드포인트 추가.
  - `OpenApiSurveyService`: CSV 파싱, 기관명 검증, 일괄 등록 로직(`bulkCreateSurveys`) 구현.
  - `BulkUploadResult` DTO 추가: 성공/실패 건수 및 실패 상세 사유 반환.
- **프론트엔드**:
  - `CsvUploadModal` 컴포넌트 구현: 드래그 앤 드롭 지원, 결과 요약 및 실패 목록 표시.
  - 프로젝트 표준 CSS(`App.css`)를 준수하도록 UI 스타일링 (Tailwind CSS 제거).
  - `surveyService`: 파일 업로드 API 연동.

### 6. 버그 수정 및 안정화 (Bug Fixes & Stabilization)
- **LazyInitializationException 해결**:
  - 문제: `OpenApiSurveyResponse`가 `Organization` 엔티티를 직접 참조하여 JSON 변환 시 세션 없음 오류 발생.
  - 해결: `OrganizationResponse` DTO를 신규 생성하고, 응답 객체가 엔티티 대신 DTO를 포함하도록 구조 변경.
- **컴파일 오류 수정**: `OpenApiSurveyController`의 누락된 `MultipartFile` import 추가.

### 7. 인증 및 보안 개선 (Authentication & Security)
- **인증 실패 응답 코드 변경**:
  - 기존: 인증 실패 시 `403 Forbidden` 반환.
  - 변경: `401 Unauthorized` 반환으로 수정.
  - 목적: 프론트엔드 Axios 인터셉터가 401 응답을 감지하여 토큰 갱신(Refresh Token) 로직을 정상적으로 수행하도록 개선.

### 8. 설문 조사 기능 고도화 (Survey Feature Enhancements)
- **'미회신' 상태 관리 추가**:
  - 모든 선택(Select) 항목에 '미회신(NO_RESPONSE)' 옵션 추가.
  - CSV 업로드 시 값이 비어있는 경우 기본값으로 '미회신' 또는 '미입력' 자동 할당.
  - 수정 화면에서 '미회신' 또는 '미입력' 항목은 붉은색 배경/텍스트로 강조 표시하여 식별 용이성 증대.
- **CSV 업로드 처리 개선**:
  - **날짜 포맷 지원 확대**: `yyyy-MM-dd` 외에 `yyyy.MM.dd` 형식의 날짜 문자열도 자동 변환하여 처리.
  - **유효성 검증 강화**: 업로드 시 각 필드의 길이(Length)를 DB 스키마와 대조하여 검증하는 로직 추가. 길이 초과 시 명확한 에러 메시지 반환.
- **타입 정의 수정**:
  - 프론트엔드 `OpenApiSurveyCreateRequest` 인터페이스의 `organizationCode` 타입 불일치 문제 해결.

### 9. 데이터베이스 스키마 변경 (Database Schema Changes)
- **연락처 컬럼 길이 확장**:
  - 테이블: `open_api_survey`
  - 컬럼: `contact_phone`
  - 변경: `VARCHAR(20)` → `VARCHAR(30)`
  - 사유: 다수의 전화번호나 긴 연락처 정보를 수용하기 위함.
