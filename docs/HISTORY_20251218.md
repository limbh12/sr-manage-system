# 변경 이력 - 2025-12-18

## 1. OPEN API 현황조사 검색 필터 기능 개선

### 개요
OPEN API 현황조사 목록 화면에서 **현재방식**과 **희망전환방식** 필터링 기능이 제대로 동작하지 않던 문제를 해결하고, 한글/영문 값 혼용 문제를 개선했습니다.

---

## 주요 변경 사항

### 1.1 현재방식/희망전환방식 검색 필터 추가

#### 문제점
- 프론트엔드에서 `currentMethod`, `desiredMethod` 검색 조건을 전송하고 있었으나
- Backend Controller가 해당 파라미터를 받지 않고 무시
- Repository 쿼리에도 해당 필드에 대한 필터링 로직이 없어 검색이 동작하지 않음

#### 해결 방법

**Backend 수정**

1. **Controller** (`OpenApiSurveyController.java`)
```java
@GetMapping
public ResponseEntity<Page<OpenApiSurveyResponse>> getSurveys(
        @RequestParam(required = false) String keyword,
        @RequestParam(required = false) String currentMethod,      // 추가
        @RequestParam(required = false) String desiredMethod,      // 추가
        @PageableDefault(...) Pageable pageable) {
    Page<OpenApiSurveyResponse> page = openApiSurveyService.getSurveys(
        keyword, currentMethod, desiredMethod, pageable);
    return ResponseEntity.ok(page);
}
```

2. **Service** (`OpenApiSurveyService.java`)
```java
@Transactional(readOnly = true)
public Page<OpenApiSurveyResponse> getSurveys(
        String keyword, String currentMethod, String desiredMethod, Pageable pageable) {

    // 빈 문자열을 null로 변환 (선택하지 않은 필터 무시)
    String normalizedCurrentMethod = (currentMethod != null && !currentMethod.trim().isEmpty())
        ? currentMethod : null;
    String normalizedDesiredMethod = (desiredMethod != null && !desiredMethod.trim().isEmpty())
        ? desiredMethod : null;

    Page<OpenApiSurvey> page = openApiSurveyRepository.search(
        keyword, keyword, normalizedCurrentMethod, normalizedDesiredMethod, pageable);
    return page.map(this::convertToResponse);
}
```

3. **Repository** (`OpenApiSurveyRepository.java`)
```java
@Query("SELECT s FROM OpenApiSurvey s LEFT JOIN s.organization o WHERE " +
       "(:keyword IS NULL OR :keyword = '' OR " +
       "LOWER(o.name) LIKE LOWER(CONCAT('%', :keyword, '%')) OR " +
       "LOWER(s.department) LIKE LOWER(CONCAT('%', :keyword, '%')) OR " +
       "LOWER(s.systemName) LIKE LOWER(CONCAT('%', :keyword, '%')) OR " +
       "s.contactName = :exactKeyword OR " +
       "s.contactPhone = :exactKeyword) AND " +
       "(:currentMethod IS NULL OR s.currentMethod = :currentMethod) AND " +
       "(:desiredMethod IS NULL OR s.desiredMethod = :desiredMethod)")
Page<OpenApiSurvey> search(@Param("keyword") String keyword,
                            @Param("exactKeyword") String exactKeyword,
                            @Param("currentMethod") String currentMethod,
                            @Param("desiredMethod") String desiredMethod,
                            Pageable pageable);
```

### 1.2 한글/영문 값 변환 로직 추가

#### 문제점
- Excel 업로드나 수동 입력 시 "중앙", "분산" 같은 한글 값이 DB에 저장됨
- 프론트엔드 select 옵션은 영문 코드(`CENTRAL`, `DISTRIBUTED`)를 사용
- 값이 매칭되지 않아 상세/수정 화면에서 항상 기본값으로 표시되는 문제

#### 해결 방법

**Backend Service** (`OpenApiSurveyService.java`)에 변환 함수 추가:

```java
/**
 * 현재방식 한글 → 영문 코드 변환
 */
private String normalizeCurrentMethod(String value) {
    if (value == null || value.trim().isEmpty()) {
        return "NO_RESPONSE";
    }

    String normalized = value.trim();
    switch (normalized) {
        case "중앙":
        case "중앙형":
            return "CENTRAL";
        case "분산":
        case "분산형":
            return "DISTRIBUTED";
        case "미회신":
            return "NO_RESPONSE";
        default:
            // 이미 영문 코드인 경우 그대로 반환
            if (normalized.equals("CENTRAL") || normalized.equals("DISTRIBUTED")
                || normalized.equals("NO_RESPONSE")) {
                return normalized;
            }
            return "NO_RESPONSE";
    }
}

/**
 * 희망전환방식 한글 → 영문 코드 변환
 */
private String normalizeDesiredMethod(String value) {
    if (value == null || value.trim().isEmpty()) {
        return "NO_RESPONSE";
    }

    String normalized = value.trim();
    switch (normalized) {
        case "중앙개선형":
        case "중앙 개선형":
            return "CENTRAL_IMPROVED";
        case "분산개선형":
        case "분산 개선형":
            return "DISTRIBUTED_IMPROVED";
        case "미회신":
            return "NO_RESPONSE";
        default:
            // 이미 영문 코드인 경우 그대로 반환
            if (normalized.equals("CENTRAL_IMPROVED")
                || normalized.equals("DISTRIBUTED_IMPROVED")
                || normalized.equals("NO_RESPONSE")) {
                return normalized;
            }
            return "NO_RESPONSE";
    }
}
```

**변환 로직 적용 위치:**
1. Excel import 시 (`bulkCreateSurveys()`)
2. API 생성 시 (`createSurvey()`)
3. API 수정 시 (`updateSurvey()`)

### 1.3 DB 마이그레이션 스크립트 제공

기존 DB에 한글 값이 저장된 경우를 위한 마이그레이션 SQL 작성:

**파일 위치:** `backend/src/main/resources/db/migration/migrate_method_values.sql`

```sql
-- 현재방식(currentMethod) 변환
UPDATE open_api_survey
SET current_method = 'CENTRAL'
WHERE current_method IN ('중앙', '중앙형');

UPDATE open_api_survey
SET current_method = 'DISTRIBUTED'
WHERE current_method IN ('분산', '분산형');

UPDATE open_api_survey
SET current_method = 'NO_RESPONSE'
WHERE current_method = '미회신' OR current_method IS NULL OR current_method = '';

-- 희망전환방식(desiredMethod) 변환
UPDATE open_api_survey
SET desired_method = 'CENTRAL_IMPROVED'
WHERE desired_method IN ('중앙개선형', '중앙 개선형');

UPDATE open_api_survey
SET desired_method = 'DISTRIBUTED_IMPROVED'
WHERE desired_method IN ('분산개선형', '분산 개선형');

UPDATE open_api_survey
SET desired_method = 'NO_RESPONSE'
WHERE desired_method = '미회신' OR desired_method IS NULL OR desired_method = '';
```

---

## 2. SR 관리 기능 개선

### 2.1 처리예정일자 필드 추가

#### 개요
SR(Service Request) 관리 시스템에 **처리예정일자** 필드를 추가하여 일정 관리 기능을 강화했습니다.

#### 주요 변경 사항

**Backend 구현**

1. **Sr 엔티티** (`Sr.java`)
```java
/** 처리예정일자 */
@Column(name = "expected_completion_date")
private LocalDate expectedCompletionDate;
```

2. **DTO 수정**
- `SrCreateRequest.java`: `expectedCompletionDate` 필드 추가
- `SrUpdateRequest.java`: `expectedCompletionDate` 필드 추가
- `SrResponse.java`: `expectedCompletionDate` 필드 추가

3. **Service 로직** (`SrService.java`)
- SR 생성/수정 시 `expectedCompletionDate` 처리 로직 추가
- 날짜 유효성 검증 추가

4. **Repository** (`SrRepository.java`)
- 처리예정일자 기반 검색 쿼리 메서드 추가

**Frontend 구현**

1. **타입 정의** (`types/index.ts`)
```typescript
export interface Sr {
  // ... 기존 필드들
  expectedCompletionDate?: string;
}
```

2. **SR 등록/수정 폼** (`SrForm.tsx`)
```typescript
<div className="form-group">
  <label className="form-label">처리예정일자</label>
  <input
    type="date"
    name="expectedCompletionDate"
    className="form-input"
    value={formData.expectedCompletionDate || ''}
    onChange={handleChange}
  />
</div>
```

3. **SR 목록** (`SrList.tsx`)
- 처리예정일자 컬럼 추가
- 처리예정일자가 내일인 경우 경고 표시 기능 추가
```typescript
const isDueTomorrow = (expectedDate?: string): boolean => {
  if (!expectedDate) return false;
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  tomorrow.setHours(0, 0, 0, 0);

  const dueDate = new Date(expectedDate);
  dueDate.setHours(0, 0, 0, 0);

  return dueDate.getTime() === tomorrow.getTime();
};
```

4. **SR 상세** (`SrDetail.tsx`)
- 처리예정일자 표시 추가

### 2.2 SR 목록 개선

#### 주요 변경 사항

**컬럼 재구성** (`SrList.tsx`)
- 기존: No, ID, 제목, 상태, 우선순위, 접수자, 담당자, 등록일, 작업
- 변경: No, ID, 분류, 요청구분, 제목, 요청자, 상태, 우선순위, 담당자, 처리예정일자, 등록일, 작업

**분류/요청구분 표시 개선**
- 공통코드 서비스를 통해 코드값을 한글명으로 변환하여 표시
```typescript
const [categoryMap, setCategoryMap] = useState<Map<string, string>>(new Map());
const [requestTypeMap, setRequestTypeMap] = useState<Map<string, string>>(new Map());

useEffect(() => {
  // 분류 코드 로드
  commonCodeService.getActiveCodesByGroup('SR_CATEGORY').then(codes => {
    const map = new Map<string, string>();
    codes.forEach(code => map.set(code.codeValue, code.codeName));
    setCategoryMap(map);
  }).catch(console.error);

  // 요청구분 코드 로드
  commonCodeService.getActiveCodesByGroup('SR_REQUEST_TYPE').then(codes => {
    const map = new Map<string, string>();
    codes.forEach(code => map.set(code.codeValue, code.codeName));
    setRequestTypeMap(map);
  }).catch(console.error);
}, []);
```

**처리예정일자 강조 표시**
- 내일이 마감인 SR의 처리예정일자를 주황색으로 강조
```typescript
<td style={{
  color: isDueTomorrow(sr.expectedCompletionDate) ? '#ff6b35' : 'inherit',
  fontWeight: isDueTomorrow(sr.expectedCompletionDate) ? 'bold' : 'normal'
}}>
  {sr.expectedCompletionDate || '-'}
</td>
```

### 2.3 SR 관리 페이지 개선

#### 주요 변경 사항 (`SrManagementPage.tsx`)

**필터 UI 개선**
- 상태 필터와 우선순위 필터의 디자인 통일
- 필터 버튼 스타일 개선 (선택 시 강조 표시)

**검색 기능 개선**
- 키워드 검색 입력창 개선
- 검색/초기화 버튼 스타일 개선

---

## 영향 범위

### Backend
- `OpenApiSurveyController.java`: 검색 파라미터 추가
- `OpenApiSurveyService.java`: 검색 로직 및 값 변환 로직 추가
- `OpenApiSurveyRepository.java`: 검색 쿼리 개선
- `Sr.java`: 처리예정일자 필드 추가
- `SrCreateRequest.java`, `SrUpdateRequest.java`, `SrResponse.java`: DTO 필드 추가
- `SrService.java`: 처리예정일자 처리 로직 추가
- `SrRepository.java`: 검색 쿼리 개선
- 마이그레이션 스크립트 추가: `db/migration/migrate_method_values.sql`

### Frontend
- `types/index.ts`: Sr 인터페이스에 처리예정일자 필드 추가
- `SrForm.tsx`: 처리예정일자 입력 필드 추가
- `SrList.tsx`: 컬럼 재구성, 처리예정일자 표시 및 강조 로직 추가
- `SrDetail.tsx`: 처리예정일자 표시 추가
- `SrManagementPage.tsx`: UI 개선
- `SurveyList.tsx`: 소스 코드 정리
- Redux Store (`srSlice.ts`): 처리예정일자 필드 추가
- Custom Hook (`useSr.ts`): 처리예정일자 필드 추가

---

## 적용 방법

### 1. Backend
```bash
cd backend
mvn clean compile
mvn spring-boot:run
```

### 2. DB 마이그레이션 (기존 데이터가 있는 경우)
```bash
# H2 Console 접속: http://localhost:8080/h2-console
# migrate_method_values.sql 파일 내용 실행
```

### 3. Frontend
```bash
cd frontend
npm run build
# 또는 개발 서버
npm run dev
```

---

## 테스트 체크리스트

### OPEN API 현황조사
- [ ] 목록 화면에서 "현재방식" 필터 선택 시 정상 필터링
- [ ] 목록 화면에서 "희망방식" 필터 선택 시 정상 필터링
- [ ] 두 필터를 동시 선택 시 AND 조건으로 필터링
- [ ] Excel 업로드 시 한글 값("중앙", "분산")이 영문 코드로 변환되어 저장
- [ ] 상세/수정 화면에서 현재방식/희망방식 값이 정상 표시

### SR 관리
- [ ] SR 등록 시 처리예정일자 입력 가능
- [ ] SR 수정 시 처리예정일자 수정 가능
- [ ] SR 목록에서 처리예정일자 표시
- [ ] 내일 마감인 SR의 처리예정일자가 주황색으로 강조 표시
- [ ] SR 상세 화면에서 처리예정일자 표시
- [ ] 분류/요청구분이 코드값이 아닌 한글명으로 표시

---

## 개선 효과

### OPEN API 현황조사
1. **검색 기능 강화**: 현재방식/희망방식 필터로 원하는 데이터를 빠르게 찾을 수 있음
2. **데이터 일관성**: 한글/영문 값 혼용 문제 해결로 데이터 품질 향상
3. **사용성 개선**: 상세/수정 화면에서 값이 정상 표시되어 편집 오류 방지

### SR 관리
1. **일정 관리**: 처리예정일자로 업무 우선순위를 효과적으로 관리
2. **마감 경고**: 내일 마감인 SR을 시각적으로 강조하여 놓치지 않도록 지원
3. **정보 가시성**: 분류/요청구분을 한글로 표시하여 가독성 향상
4. **UI/UX 개선**: 컬럼 재구성으로 중요 정보를 한눈에 파악 가능

---

## 참고사항

### OPEN API 현황조사
- 기존 DB에 한글 값이 저장되어 있는 경우, 반드시 마이그레이션 스크립트를 실행해야 함
- 앞으로 Excel 업로드 시 한글/영문 값 모두 자동 변환되므로 별도 작업 불필요

### SR 관리
- 처리예정일자는 선택 항목이며, 필수 입력이 아님
- 처리예정일자가 과거인 경우에 대한 별도 경고는 아직 구현되지 않음 (향후 개선 가능)
- 내일 마감 강조 기능은 브라우저의 현재 시간을 기준으로 동작함

---

## 다음 개선 계획

1. SR 처리예정일자 관련
   - 처리예정일자가 과거인 경우 빨간색으로 강조
   - 대시보드에 마감 임박 SR 목록 표시
   - 알림 기능 추가

2. OPEN API 현황조사 관련
   - 통계 대시보드 추가 (현재방식/희망방식별 집계)
   - Excel export 기능 추가
   - 일괄 수정 기능 추가
